<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メインページ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-white rounded-lg shadow-lg p-8">
            
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">メインページ</h1>

            <!-- 現在参加している講義の情報 -->
            {% if current_lecture %}
                <div class="bg-gray-50 rounded-lg p-3 mb-2">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">現在参加中の講義</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">教室:</span>
                            <span class="ml-2 font-medium">{{ current_lecture.classroom }}</span>
                        </div>
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">時限:</span>
                            <span class="ml-2 font-medium">{{ current_lecture.period }}</span>
                        </div>
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">曜日:</span>
                            <span class="ml-2 font-medium">{{ current_lecture.day_of_week }}</span>
                        </div>
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">開始時間:</span>
                            <span class="ml-2 font-medium">{{ current_lecture.start_time }}</span>
                        </div>
                    </div>
                </div>
            {% else %}
                <p>現在参加中の講義はありません。</p>
            {% endif %}

            <!-- 既存の情報表示セクション -->
            <div class="bg-gray-50 rounded-lg p-3 mb-2">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">講義情報</h2>
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-white px-3 py-2 rounded shadow-sm">
                        <span class="text-sm text-gray-600">教室:</span>
                        <span class="ml-2 font-medium">{{ classroom }}</span>
                    </div>
                    <div class="bg-white px-3 py-2 rounded shadow-sm">
                        <span class="text-sm text-gray-600">座席:</span>
                        <span class="ml-2 font-medium">{{ seat_number }}</span>
                    </div>
                    <div class="bg-white px-3 py-2 rounded shadow-sm">
                        <span class="text-sm text-gray-600">時限:</span>
                        <span class="ml-2 font-medium">{{ period }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ビデオ表示エリア（より大きく） -->
        <div class="mb-4">
            <video id="video" autoplay muted class="w-full rounded-lg shadow-md"></video>
        </div>

            <!-- フッター -->
            <div class="flex justify-center">
                <!-- 退出するボタン -->
                <form method="POST" action="{{ url_for('app.student.lecture.exit') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit"
                            class="w-full inline-flex items-center justify-center px-6 py-3 bg-red-500 text-white font-medium rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        講義から退出する
                    </button>
                </form>

                <a href="{{ url_for('app.auth.logout') }}" 
                   class="inline-flex items-center justify-center px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                    ログアウト
                </a>
            </div>
            
        </div>
    </div>


    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script>
        // URLクエリパラメータからalert_messageを取得する
        const urlParams = new URLSearchParams(window.location.search);
        const alertMessage = urlParams.get("alert_message");

        // アラートメッセージがある場合に表示
        if (alertMessage) {
            alert(alertMessage);

            // URLからクエリパラメータを消去
            const newURL = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, newURL);
        }

        const socket = io();
        socket.emit('main_page_visited');
        const video = document.getElementById('video');

        // カメラを起動して映像を表示
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(error => {
                console.error("カメラの使用を許可してください。", error);
            });
        
        const lectureId = "{{ current_lecture.id }}";

        // 5秒ごとに画像データを取得し、サーバーに送信
        setInterval(() => {
            // 画面キャプチャ用のCanvasを作成
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 画像データを取得し、サーバーに送信
            const imageData = canvas.toDataURL('image/jpeg');
            socket.emit('monitor_eye_openness', { imageData: imageData, lectureId: lectureId });
        }, 5000); // 5秒間隔で送信

        // サーバーからの画像データを受信して表示（必要ならば）
        socket.on('image_update', function(imageData) {
            video.src = 'data:image/jpeg;base64,' + imageData;
        });

        // ページ読み込み時に通知の許可をリクエスト
        document.addEventListener('DOMContentLoaded', () => {
            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        });
        
        function showNotification(message) {
            if (Notification.permission === 'granted') {
                new Notification('通知', { body: message });
            } else {
                console.log("通知が許可されていません");
            }
        }
        

        // サーバーからの警告メッセージを受信したら通知を表示
        socket.on('low_eye_openness_alert', function(data) {
            showNotification(data.message);
        });


    </script>
</body>
</html>

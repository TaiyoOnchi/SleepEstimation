<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メインページ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    {% include 'partials/header.html' %}<!-- ヘッダーを読み込み -->

    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-gray-50 rounded-lg p-3 mb-2">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">統計情報</h2>
            <div class="grid grid-cols-2 gap-2">
                <!-- student_subjects -->
                <div class="bg-white px-3 py-2 rounded shadow-sm">
                    <span class="text-sm text-gray-600">累計注意:</span>
                    <span id="total-attentions" class="ml-2 font-medium">{{ total_attentions }}</span>
                </div>
                <div class="bg-white px-3 py-2 rounded shadow-sm">
                    <span class="text-sm text-gray-600">累計警告:</span>
                    <span id="total-warnings" class="ml-2 font-medium">{{ total_warnings }}</span>
                </div>
                <!-- student_participations -->
                <div class="bg-white px-3 py-2 rounded shadow-sm">
                    <span class="text-sm text-gray-600">今回の注意回数:</span>
                    <span id="attention-count" class="ml-2 font-medium">{{ attention_count }}</span>
                </div>
                <div class="bg-white px-3 py-2 rounded shadow-sm">
                    <span class="text-sm text-gray-600">今回の警告回数:</span>
                    <a href="{{ url_for('app.student.lecture.warnings', participation_id=student_participation_id) }}" id="warning-count" class="ml-2 font-medium text-blue-500 hover:underline">
                        {{ warning_count }}
                    </a>
                </div>                
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-8">
            
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">メインページ</h1>

            {% if current_lecture %}
                <div class="bg-gray-50 rounded-lg p-3 mb-2">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">現在参加中の講義</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">教室:</span>
                            <span class="ml-2 font-medium">{{ current_lecture.classroom }}</span>
                        </div>
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">時限:</span>
                            <span class="ml-2 font-medium">{{ current_lecture.period }}</span>
                        </div>
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">曜日:</span>
                            <span class="ml-2 font-medium">{{ current_lecture.day_of_week }}</span>
                        </div>
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">開始時間:</span>
                            <span class="ml-2 font-medium">{{ current_lecture.start_time }}</span>
                        </div>
                        <!-- 座席番号の追加 -->
                        <div class="bg-white px-3 py-2 rounded shadow-sm">
                            <span class="text-sm text-gray-600">座席番号:</span>
                            <span class="ml-2 font-medium">{{ seat_number }}</span>
                        </div>
                    </div>
                </div>
            {% else %}
                <p>現在参加中の講義はありません。</p>
            {% endif %}


        </div>

                                        
        <div id="eye-openness-display" class="text-center text-gray-500 font-medium mb-2"></div>
        <div id="video-container" class="border-8 border-gray-300 rounded-lg mb-4">
            <img id="processedImage" class="w-full rounded-lg shadow-md" alt="Processed Image">
        </div>
        
    </div>


    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script>
        // URLクエリパラメータからalert_messageを取得する
        const urlParams = new URLSearchParams(window.location.search);
        const alertMessage = urlParams.get("alert_message");

        // アラートメッセージがある場合に表示
        if (alertMessage) {
            alert(alertMessage);

            // URLからクエリパラメータを消去
            const newURL = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, newURL);
        }

        const socket = io();
        socket.emit('student_join_room');
        
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            const video = document.createElement('video'); // 非表示のビデオ要素を作成
            video.srcObject = stream;
            video.play();

            // 2秒ごとに処理された画像を送信
            setInterval(() => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // 画像データを取得してサーバーに送信
                const imageData = canvas.toDataURL('image/jpeg');
                socket.emit('monitor_eye_openness', { imageData, student_participation_id });
            }, 2000);
        })
        .catch(error => {
            alert('カメラにアクセスできません。ブラウザの設定でカメラアクセスを許可してください。');
            console.error("カメラの使用を許可してください。", error);
        });
        
        const student_participation_id = "{{ student_participation_id }}";

        // 5秒ごとに画像データを取得し、サーバーに送信
        setInterval(() => {
            // 画面キャプチャ用のCanvasを作成
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 画像データを取得し、サーバーに送信
            const imageData = canvas.toDataURL('image/jpeg');
            socket.emit('monitor_eye_openness', { imageData: imageData, student_participation_id: student_participation_id });
        }, 2000); // 5秒間隔で送信

        // サーバーからの画像データを受信して表示（必要ならば）
        socket.on('image_update', function(imageData) {
            video.src = 'data:image/jpeg;base64,' + imageData;
        });

        // ページ読み込み時に通知の許可をリクエスト
        document.addEventListener('DOMContentLoaded', () => {
            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        });
        
        function showNotification(message) {
            if (Notification.permission === 'granted') {
                new Notification('通知', { body: message });
            } else {
                console.log("通知が許可されていません");
            }
        }
        

        socket.on('eye_openness_update', function(data) {
            const maxEyeOpenness = data.maxEyeOpenness;
            const eroThreshold = data.eroThreshold;
            const warningThreshold = ((100 - eroThreshold) / 2) + eroThreshold;
        
            const videoContainer = document.getElementById('video-container');
            const eyeOpennessDisplay = document.getElementById('eye-openness-display');
        
            if (maxEyeOpenness === null || maxEyeOpenness === undefined) {
                // 開眼率が測定されていない場合
                videoContainer.className = 'border-8 border-gray-300 rounded-lg mb-4';
                eyeOpennessDisplay.textContent = '測定不能';
                eyeOpennessDisplay.className = 'text-center text-gray-500 font-medium mb-2';
            } else if (maxEyeOpenness >= warningThreshold) {
                videoContainer.className = 'border-8 border-green-500 rounded-lg mb-4';
                eyeOpennessDisplay.textContent = `開眼率: ${maxEyeOpenness.toFixed(2)}%`;
                eyeOpennessDisplay.className = 'text-center text-green-500 font-medium mb-2';
            } else if (maxEyeOpenness >= eroThreshold) {
                videoContainer.className = 'border-8 border-yellow-500 rounded-lg mb-4';
                eyeOpennessDisplay.textContent = `開眼率: ${maxEyeOpenness.toFixed(2)}%`;
                eyeOpennessDisplay.className = 'text-center text-yellow-500 font-medium mb-2';
            } else {
                videoContainer.className = 'border-8 border-red-500 rounded-lg mb-4';
                eyeOpennessDisplay.textContent = `開眼率: ${maxEyeOpenness.toFixed(2)}%`;
                eyeOpennessDisplay.className = 'text-center text-red-500 font-medium mb-2';
            }
        });
        

        // サーバーからの警告メッセージを受信したら通知を表示
        socket.on('low_eye_openness_alert', function(data) {
            showNotification(data.message);
        });


        socket.on('attention_alert', function(data) {
            // 通知を表示
            showNotification(data.message);
            
            // 注意回数をインクリメント
            const attentionCountElement = document.getElementById('attention-count');
            const totalAttentionsElement = document.getElementById('total-attentions');
            let currentAttentionCount = parseInt(attentionCountElement.textContent);
            let totalAttentionsCount = parseInt(totalAttentionsElement.textContent);
        
            currentAttentionCount += 1;
            totalAttentionsCount += 1;
        
            attentionCountElement.textContent = currentAttentionCount;
            totalAttentionsElement.textContent = totalAttentionsCount;
        });
        
        socket.on('warning_alert', function(data) {
            // 通知を表示
            showNotification(data.message);
            
            // 警告回数をインクリメント
            const warningCountElement = document.getElementById('warning-count');
            const totalWarningsElement = document.getElementById('total-warnings');
            let currentWarningCount = parseInt(warningCountElement.textContent);
            let totalWarningsCount = parseInt(totalWarningsElement.textContent);
        
            currentWarningCount += 1;
            totalWarningsCount += 1;
        
            warningCountElement.textContent = currentWarningCount;
            totalWarningsElement.textContent = totalWarningsCount;
        });
        

        socket.on('session_exit', function(data) {
            alert(data.message);
            window.location.href = data.redirect_url;
        });
        
        socket.on('low_eye_openness_warning', function(data) {
            const dialogContainer = document.createElement('div');
            dialogContainer.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50';
            
            dialogContainer.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <p class="text-gray-800 mb-4">開眼率が低下しています、眠たいですか？</p>
                    <div class="flex justify-between">
                        <button id="yes-btn" class="bg-green-500 text-white px-4 py-2 rounded">はい</button>
                        <button id="no-btn" class="bg-red-500 text-white px-4 py-2 rounded">いいえ(誤検出)</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialogContainer);
        
            document.getElementById('yes-btn').onclick = function() {
                socket.emit('response_low_eye_openness', { response: 'yes' });
                document.body.removeChild(dialogContainer);
            };
        
            document.getElementById('no-btn').onclick = function() {
                document.body.removeChild(dialogContainer);
                
                // ここで attention_id を保存（仮に new_attention_id とします）
                attention_id = data.attention_id;  // サーバーから受け取った attention_id を保存
                socket.emit('response_low_eye_openness', { 
                    response: 'no',
                    attention_id: attention_id  // attention_id を送信
                });
            
                const baselineDialog = document.createElement('div');
                baselineDialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50';
                
                baselineDialog.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-lg">
                        <p class="text-gray-800 mb-4">開眼率の基準値を下げますか？</p>
                        <div class="flex justify-between">
                            <button id="lower-baseline-yes" class="bg-green-500 text-white px-4 py-2 rounded">はい</button>
                            <button id="lower-baseline-no" class="bg-red-500 text-white px-4 py-2 rounded">いいえ</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(baselineDialog);
            
                document.getElementById('lower-baseline-yes').onclick = function() {
                    socket.emit('adjust_baseline', { adjust: 'yes' });
                    document.body.removeChild(baselineDialog);
                };
            
                document.getElementById('lower-baseline-no').onclick = function() {
                    socket.emit('adjust_baseline', { adjust: 'no' });
                    document.body.removeChild(baselineDialog);
                };
            };
            
        });
        
        socket.on('baseline_adjusted', function(data) {
            console.log(data.message);
            alert(data.message); // 必要に応じてアラート表示
        });
        
        // サーバーからの画像データを受信して <img> タグに表示
        socket.on('processed_frame', (data) => {
            const imgElement = document.getElementById('processedImage');
            imgElement.src = `data:image/jpeg;base64,${data.image}`;
        });

        
        
    </script>
</body>
</html>

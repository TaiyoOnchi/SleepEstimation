<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>講義回詳細</title>
</head>
<body>
    <h1>講義回詳細</h1>
    {% include 'partials/flash_messages.html' %}

    <h2>{{ lecture_session.day_of_week }} 第{{ lecture_session.period }}限 - {{ lecture_session.classroom }}</h2>
    <p>開始時刻: {{ lecture_session.start_time }}</p>
    <p>終了時刻: {{ lecture_session.end_time }}</p>
    <p>参加コード: {{ lecture_session.join_code }}</p>
    {% if not lecture_session.end_time %}
    <!-- 講義終了ボタン -->
        <form action="{{ url_for('app.teacher.lecture.end_session', session_id=lecture_session.id) }}" method="post" onsubmit="return confirmEndSession()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit">講義を終了</button>
        </form>
    {% endif %}

    <h3>参加学生</h3>
    <table border="1" id="participants">
        <thead>
            <tr>
                <th>学籍番号</th>
                <th>カナ</th>
                <th>氏名</th>
                <th>出席時刻</th>
                <th>退席時刻</th>
                <th>注意回数</th>
                <th>警告回数</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for student in student_participations %}
            <tr data-student-number="{{ student.student_number }}">
                <td>
                    <a href="{{ url_for('app.teacher.lecture.session_student_details', session_id=lecture_session.id, student_id=student.id) }}">{{ student.student_number }}</a>
                </td>
                <td>{{ student.last_name }} {{ student.first_name }}</td>
                <td>{{ student.kana_last_name }} {{ student.kana_first_name }}</td>
                <td>{{ student.attendance_time }}</td>
                <td>{{ student.exit_time }}</td>
                <td>{{ student.attention_count }}</td>
                <td>{{ student.warning_count }}</td>
                <td><a href="{{ url_for('app.teacher.lecture.create_warning', student_id=student.id) }}">警告を送信</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <p><a href="{{ url_for('app.teacher.dashboard.dashboard') }}">ダッシュボードに戻る</a></p>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            socket.emit('teacher_join_room');

            // サーバーから lecture_session.id を渡す
            const sessionId = {{ lecture_session.id|tojson }};
            
            socket.on('student_joined', function(data) {
                const table = document.getElementById('participants').getElementsByTagName('tbody')[0];
                if (!table) {
                    console.error("Table not found!");
                    return;
                }
                const newRow = table.insertRow();

                // 学籍番号セルにリンクを作成
                const studentNumberCell = newRow.insertCell(0);
                const studentLink = document.createElement('a');
                studentLink.href = `/teacher/session/${sessionId}/student/${data.id}`;
                studentLink.textContent = data.student_number;
                studentNumberCell.appendChild(studentLink);
                
                newRow.insertCell(1).textContent = `${data.kana_last_name} ${data.kana_first_name}`;
                newRow.insertCell(2).textContent = `${data.last_name} ${data.first_name}`;
                newRow.insertCell(3).textContent = data.attendance_time;
                newRow.insertCell(4).textContent = data.exit_time || 'None';
                newRow.insertCell(5).textContent = data.attention_count;
                newRow.insertCell(6).textContent = data.warning_count;
                // 「警告を送信」ボタンを追加
                const warningCell = newRow.insertCell(7);
                const warningLink = document.createElement('a');
                warningLink.href = `/teacher/create_warning?student_id=${data.id}`;
                warningLink.textContent = '警告を送信';
                warningCell.appendChild(warningLink);
            });

            // 学生が退出した場合の処理
            socket.on('student_exited', function(data) {
                const table = document.getElementById('participants').getElementsByTagName('tbody')[0];
                const row = table.querySelector(`tr[data-student-number="${data.student_number}"]`);
                if (row) {
                    row.cells[4].textContent = data.exit_time; // 退出時間を更新
                }
            });
            

            // 注意回数更新通知
            socket.on('attention_updated', function(data) {
                const table = document.getElementById('participants').getElementsByTagName('tbody')[0];
                for (let row of table.rows) {
                    if (row.cells[0].textContent === data.student_number) {
                        row.cells[5].textContent = data.attention_count; // 注意回数を更新
                        return;
                    }
                }
            });

            // 警告回数更新通知
            socket.on('warning_updated', function(data) {
                const table = document.getElementById('participants').getElementsByTagName('tbody')[0];
                for (let row of table.rows) {
                    if (row.cells[0].textContent === data.student_number) {
                        row.cells[6].textContent = data.warning_count; // 警告回数を更新
                        return;
                    }
                }
            });
        });
        


        function confirmEndSession() {
            return confirm("本当に講義を終了しますか？");
        }

        
    </script>
</body>
</html>
